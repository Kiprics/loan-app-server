require("dotenv").config();
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const path = require("path"); // ðŸ’¡ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð¿ÑƒÑ‚ÑÐ¼Ð¸

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ middleware Ð´Ð»Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
const authMiddleware = require("./middleware/authMiddleware");

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Express
const app = express();

// ÐœÐ¸Ð´Ð´Ð»Ð²Ð°Ñ€Ñ‹
app.use(cors());
app.use(express.json());

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº MongoDB
mongoose.connect(process.env.MONGO_URI, {});

const db = mongoose.connection;
db.on("error", console.error.bind(console, "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MongoDB:"));
db.once("open", async () => {
  console.log("âœ… MongoDB Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°!");
});

// ÐŸÑ€Ð¾ÑÑ‚ÐµÐ¹ÑˆÐ¸Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ (Ñ‚ÐµÑÑ‚ API)
app.get("/api", (req, res) => res.send("API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"));

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
const authRoutes = require("./routes/authRoutes");
app.use("/api/auth", authRoutes);

const applicationRoutes = require("./routes/applicationRoutes");
app.use("/api", applicationRoutes);

const fileRoutes = require("./routes/fileRoutes");
app.use("/api", fileRoutes);

// ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸)
app.get("/api/protected-route", authMiddleware, (req, res) => {
  res.json({
    message: "ðŸ”’ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½!",
    user: req.user, // id Ð¸ role ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ° Ð¸Ð· Ñ‚Ð¾ÐºÐµÐ½Ð°
  });
});

// âš ï¸ Ð Ð°Ð·Ð´Ð°Ñ‡Ð° Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð° (React Build)
app.use(express.static(path.join(__dirname, "public")));

app.get("*", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€ Ð½Ð° ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¼ Ð¿Ð¾Ñ€Ñ‚Ñƒ
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`));
